<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>synchronized 与锁 | 焦糖咖啡</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/blog/img/favicon.ico">
    <meta name="description" content="写点东西">
    <meta name="keywords" content="写点东西">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/blog/assets/css/0.styles.6741cb35.css" as="style"><link rel="preload" href="/blog/assets/js/app.c0e2c8ea.js" as="script"><link rel="preload" href="/blog/assets/js/2.5f0b0e2a.js" as="script"><link rel="preload" href="/blog/assets/js/25.57d86784.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.1ff019fd.js"><link rel="prefetch" href="/blog/assets/js/11.9b8763b0.js"><link rel="prefetch" href="/blog/assets/js/12.82651557.js"><link rel="prefetch" href="/blog/assets/js/13.315fa59d.js"><link rel="prefetch" href="/blog/assets/js/14.53eabea6.js"><link rel="prefetch" href="/blog/assets/js/15.47575206.js"><link rel="prefetch" href="/blog/assets/js/16.b0253bbd.js"><link rel="prefetch" href="/blog/assets/js/17.985e1d5d.js"><link rel="prefetch" href="/blog/assets/js/18.141b30e9.js"><link rel="prefetch" href="/blog/assets/js/19.738084b5.js"><link rel="prefetch" href="/blog/assets/js/20.d1522201.js"><link rel="prefetch" href="/blog/assets/js/21.8a0499d2.js"><link rel="prefetch" href="/blog/assets/js/22.6e9a0603.js"><link rel="prefetch" href="/blog/assets/js/23.78bfe7e7.js"><link rel="prefetch" href="/blog/assets/js/24.efb103a8.js"><link rel="prefetch" href="/blog/assets/js/26.f1761e5b.js"><link rel="prefetch" href="/blog/assets/js/27.ae3e65f6.js"><link rel="prefetch" href="/blog/assets/js/28.c1030bc2.js"><link rel="prefetch" href="/blog/assets/js/29.5dee61d5.js"><link rel="prefetch" href="/blog/assets/js/3.4fd1a213.js"><link rel="prefetch" href="/blog/assets/js/30.1a83b3c3.js"><link rel="prefetch" href="/blog/assets/js/31.e393706f.js"><link rel="prefetch" href="/blog/assets/js/32.ad901ecf.js"><link rel="prefetch" href="/blog/assets/js/33.e89f3bde.js"><link rel="prefetch" href="/blog/assets/js/34.5b3a8788.js"><link rel="prefetch" href="/blog/assets/js/35.157adb89.js"><link rel="prefetch" href="/blog/assets/js/36.f6d552f1.js"><link rel="prefetch" href="/blog/assets/js/37.e7d5df09.js"><link rel="prefetch" href="/blog/assets/js/38.4e37d0d4.js"><link rel="prefetch" href="/blog/assets/js/39.ec5f7bb9.js"><link rel="prefetch" href="/blog/assets/js/4.f535c559.js"><link rel="prefetch" href="/blog/assets/js/40.e5f467cc.js"><link rel="prefetch" href="/blog/assets/js/41.6f501b07.js"><link rel="prefetch" href="/blog/assets/js/42.5194b38d.js"><link rel="prefetch" href="/blog/assets/js/43.12e6077e.js"><link rel="prefetch" href="/blog/assets/js/44.37e16b5e.js"><link rel="prefetch" href="/blog/assets/js/45.727e66c5.js"><link rel="prefetch" href="/blog/assets/js/46.70de12e4.js"><link rel="prefetch" href="/blog/assets/js/47.357fedbb.js"><link rel="prefetch" href="/blog/assets/js/48.327a7ce9.js"><link rel="prefetch" href="/blog/assets/js/49.7453a960.js"><link rel="prefetch" href="/blog/assets/js/5.042b1c29.js"><link rel="prefetch" href="/blog/assets/js/50.3751f67a.js"><link rel="prefetch" href="/blog/assets/js/51.c8209e80.js"><link rel="prefetch" href="/blog/assets/js/52.6f5911f9.js"><link rel="prefetch" href="/blog/assets/js/53.38017f2f.js"><link rel="prefetch" href="/blog/assets/js/54.45cdd142.js"><link rel="prefetch" href="/blog/assets/js/55.893acdf5.js"><link rel="prefetch" href="/blog/assets/js/56.9ea65a14.js"><link rel="prefetch" href="/blog/assets/js/57.49899467.js"><link rel="prefetch" href="/blog/assets/js/58.6fa3d803.js"><link rel="prefetch" href="/blog/assets/js/59.d251a723.js"><link rel="prefetch" href="/blog/assets/js/6.e76f28d5.js"><link rel="prefetch" href="/blog/assets/js/60.07bde458.js"><link rel="prefetch" href="/blog/assets/js/61.bdd246d8.js"><link rel="prefetch" href="/blog/assets/js/7.45db2f12.js"><link rel="prefetch" href="/blog/assets/js/8.ebbfeb54.js"><link rel="prefetch" href="/blog/assets/js/9.6696f1c8.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.6741cb35.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/caramel.svg" alt="焦糖咖啡" class="logo"> <span class="site-name can-hide">焦糖咖啡</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="☕️ 后端" class="dropdown-title"><a href="/blog/backend/" class="link-title">☕️ 后端</a> <span class="title" style="display:none;">☕️ 后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/30CC282E3031EE17D51DE216B9770F64/" class="nav-link">🐦 Mybatis</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/456/" class="nav-link">🍀 Spring</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/8195420838640189FB0A4FE4DF735AC3/" class="nav-link">🔀 并发</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/CE0BE71E33226E4C1DB2BCEA5959F16B/" class="nav-link">🗒 日志技术</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/20AAECA132F5374F93ED7A729372FD11/" class="nav-link">♏️ Maven</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/9995FFCC91A71EEB078DC37166C32299/" class="nav-link">☕️ JVM</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🐧 Linux" class="dropdown-title"><a href="/blog/linux/" class="link-title">🐧 Linux</a> <span class="title" style="display:none;">🐧 Linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/F06F0728CB89A1C07D8FF2E1591C0F67/" class="nav-link">🍎 MacOS</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/8393A0BE6BAB7607AD6DA5B775777F7F/" class="nav-link">🇨🇳 Deepin</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/E86C652BD5EF1839E5E5137B27A2C29C/" class="nav-link">🍓 Raspberry</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/9AAE2F4EAD9E7D19169CE50CD6F55A53/" class="nav-link">🦊 aliyun</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🛢 数据库" class="dropdown-title"><a href="/blog/database/" class="link-title">🛢 数据库</a> <span class="title" style="display:none;">🛢 数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/8309a5b876fc95e3/" class="nav-link">🐬 MySQL</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🖥 前端" class="dropdown-title"><a href="/blog/frontend/" class="link-title">🖥 前端</a> <span class="title" style="display:none;">🖥 前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="💊 其他" class="dropdown-title"><a href="/blog/other/" class="link-title">💊 其他</a> <span class="title" style="display:none;">💊 其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/940bde/" class="nav-link">🔢 算法</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/359857/" class="nav-link">➿ 数据结构</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🔨 运维" class="dropdown-title"><a href="/blog/operations/" class="link-title">🔨 运维</a> <span class="title" style="display:none;">🔨 运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/793F209C5CB18C9DBEDBF8EDCA4E920D/" class="nav-link">👴 Jenkins</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🔐 个人" class="dropdown-title"><a href="/blog/personal/" class="link-title">🔐 个人</a> <span class="title" style="display:none;">🔐 个人</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/74A01D29A0BB08D490A6DD5E21FEC279/" class="nav-link">🍮 Caramel</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/D26D94237A5A5BB942960BE61C0C58C7/" class="nav-link">💬 ChatGPT</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="⭐️ 收藏" class="dropdown-title"><a href="/blog/favorite/" class="link-title">⭐️ 收藏</a> <span class="title" style="display:none;">⭐️ 收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/beb6c0bd8a66cea6/" class="nav-link">网站</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/eee83a9211a70f9d/" class="nav-link">资源</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/12df8ace52d493f6/" class="nav-link">Vue资源</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🚀 索引" class="dropdown-title"><a href="/blog/index/" class="link-title">🚀 索引</a> <span class="title" style="display:none;">🚀 索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/blog/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/blog/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/Fitminf" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://fitminfpicgo.oss-cn-guangzhou.aliyuncs.com/picgo/202209221704957.jpeg"> <div class="blogger-info"><h3>Fitminf</h3> <span>雾里看花</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="☕️ 后端" class="dropdown-title"><a href="/blog/backend/" class="link-title">☕️ 后端</a> <span class="title" style="display:none;">☕️ 后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/30CC282E3031EE17D51DE216B9770F64/" class="nav-link">🐦 Mybatis</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/456/" class="nav-link">🍀 Spring</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/8195420838640189FB0A4FE4DF735AC3/" class="nav-link">🔀 并发</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/CE0BE71E33226E4C1DB2BCEA5959F16B/" class="nav-link">🗒 日志技术</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/20AAECA132F5374F93ED7A729372FD11/" class="nav-link">♏️ Maven</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/9995FFCC91A71EEB078DC37166C32299/" class="nav-link">☕️ JVM</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🐧 Linux" class="dropdown-title"><a href="/blog/linux/" class="link-title">🐧 Linux</a> <span class="title" style="display:none;">🐧 Linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/F06F0728CB89A1C07D8FF2E1591C0F67/" class="nav-link">🍎 MacOS</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/8393A0BE6BAB7607AD6DA5B775777F7F/" class="nav-link">🇨🇳 Deepin</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/E86C652BD5EF1839E5E5137B27A2C29C/" class="nav-link">🍓 Raspberry</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/9AAE2F4EAD9E7D19169CE50CD6F55A53/" class="nav-link">🦊 aliyun</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🛢 数据库" class="dropdown-title"><a href="/blog/database/" class="link-title">🛢 数据库</a> <span class="title" style="display:none;">🛢 数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/8309a5b876fc95e3/" class="nav-link">🐬 MySQL</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🖥 前端" class="dropdown-title"><a href="/blog/frontend/" class="link-title">🖥 前端</a> <span class="title" style="display:none;">🖥 前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="💊 其他" class="dropdown-title"><a href="/blog/other/" class="link-title">💊 其他</a> <span class="title" style="display:none;">💊 其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/940bde/" class="nav-link">🔢 算法</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/359857/" class="nav-link">➿ 数据结构</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🔨 运维" class="dropdown-title"><a href="/blog/operations/" class="link-title">🔨 运维</a> <span class="title" style="display:none;">🔨 运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/793F209C5CB18C9DBEDBF8EDCA4E920D/" class="nav-link">👴 Jenkins</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🔐 个人" class="dropdown-title"><a href="/blog/personal/" class="link-title">🔐 个人</a> <span class="title" style="display:none;">🔐 个人</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/74A01D29A0BB08D490A6DD5E21FEC279/" class="nav-link">🍮 Caramel</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/D26D94237A5A5BB942960BE61C0C58C7/" class="nav-link">💬 ChatGPT</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="⭐️ 收藏" class="dropdown-title"><a href="/blog/favorite/" class="link-title">⭐️ 收藏</a> <span class="title" style="display:none;">⭐️ 收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/beb6c0bd8a66cea6/" class="nav-link">网站</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/eee83a9211a70f9d/" class="nav-link">资源</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/12df8ace52d493f6/" class="nav-link">Vue资源</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="🚀 索引" class="dropdown-title"><a href="/blog/index/" class="link-title">🚀 索引</a> <span class="title" style="display:none;">🚀 索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/blog/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/blog/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/Fitminf" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>并发</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>多线程基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/pages/8195420838640189FB0A4FE4DF735AC3/" class="sidebar-link">多线程基础-前言</a></li><li><a href="/blog/pages/E0C00D6AE4A3E986826158458B77D1D1/" class="sidebar-link">进程与线程的基本概念</a></li><li><a href="/blog/pages/3AB261F33EB6C988264803D7CA2BB2FF/" class="sidebar-link">Java 多线程入门类和接口</a></li><li><a href="/blog/pages/DBE619D09CEA04CC6213F255788CF55F/" class="sidebar-link">线程组和线程优先级</a></li><li><a href="/blog/pages/C02197884392435BF1BA9D1308309986/" class="sidebar-link">Java 线程的状态及主要转化方法</a></li><li><a href="/blog/pages/D1BC6B84013898EE06858BEED4DBFDDE/" class="sidebar-link">Java 线程间的通信</a></li><li><a href="/blog/pages/3F680997B147411984C18399D0BA3637/" class="sidebar-link">Java 内存模型基础知识</a></li><li><a href="/blog/pages/CBB94F18ABF09C75EFBEAFF5B5B2E9C3/" class="sidebar-link">重排序与 happens-before</a></li><li><a href="/blog/pages/9117624F898B90EBCA2D62EB460494B3/" class="sidebar-link">volatile</a></li><li><a href="/blog/pages/6793954249610BB5496B80ABF3CCDD4C/" aria-current="page" class="active sidebar-link">synchronized 与锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/blog/pages/6793954249610BB5496B80ABF3CCDD4C/#synchronized关键字" class="sidebar-link">Synchronized关键字</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/6793954249610BB5496B80ABF3CCDD4C/#几种锁" class="sidebar-link">几种锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/blog/pages/6793954249610BB5496B80ABF3CCDD4C/#java对象头" class="sidebar-link">Java对象头</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/6793954249610BB5496B80ABF3CCDD4C/#偏向锁" class="sidebar-link">偏向锁</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/6793954249610BB5496B80ABF3CCDD4C/#实现原理" class="sidebar-link">实现原理</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/6793954249610BB5496B80ABF3CCDD4C/#撤销偏向锁" class="sidebar-link">撤销偏向锁</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/6793954249610BB5496B80ABF3CCDD4C/#轻量级锁" class="sidebar-link">轻量级锁</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/6793954249610BB5496B80ABF3CCDD4C/#轻量级锁的加锁" class="sidebar-link">轻量级锁的加锁</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/6793954249610BB5496B80ABF3CCDD4C/#重量级锁" class="sidebar-link">重量级锁</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/6793954249610BB5496B80ABF3CCDD4C/#总结锁的升级流程" class="sidebar-link">总结锁的升级流程</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/6793954249610BB5496B80ABF3CCDD4C/#各种锁的优缺点对比" class="sidebar-link">各种锁的优缺点对比</a></li></ul></li></ul></li><li><a href="/blog/pages/2DF17B63FC62C4F8A42E7571CC8950E3/" class="sidebar-link">CAS 与原子操作</a></li><li><a href="/blog/pages/EFB18D72E658D79B4119513903AE1FE0/" class="sidebar-link">AQS</a></li><li><a href="/blog/pages/71169A26ECD407579898F55243F9AB1C/" class="sidebar-link">线程池原理</a></li><li><a href="/blog/pages/15EC8CC55EADDDBD47AE48C8FF7CB830/" class="sidebar-link">阻塞队列</a></li><li><a href="/blog/pages/5631FD676F19A6B0B22F6328506D9A29/" class="sidebar-link">锁接口和类</a></li><li><a href="/blog/pages/2AC63B2FF1781094B3E6759A19A86EF1/" class="sidebar-link">并发容器集合</a></li><li><a href="/blog/pages/4A32DB4E94730A7AFD0788CAFC211337/" class="sidebar-link">CopyOnWrite 容器</a></li><li><a href="/blog/pages/9C035E827AFBD83B38A13FEF6FB54A5D/" class="sidebar-link">通信工具类</a></li><li><a href="/blog/pages/05DF14A90560D22C3674A8B5C17D17F7/" class="sidebar-link">Fork、Join 框架</a></li><li><a href="/blog/pages/ACDF61D0A91C4E03F959F6FFEBB39894/" class="sidebar-link">Java 8 Stream 并行计算原理</a></li><li><a href="/blog/pages/6AA4BA7E676FFEDA11262CD5B7C18218/" class="sidebar-link">计划任务</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志技术</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Maven</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/blog/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/blog/backend/#后端" data-v-06225672>后端</a></li><li data-v-06225672><a href="/blog/backend/#并发" data-v-06225672>并发</a></li><li data-v-06225672><a href="/blog/backend/#多线程基础" data-v-06225672>多线程基础</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/Fitminf" target="_blank" title="作者" class="beLink" data-v-06225672>fitminf</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-09-29</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">synchronized 与锁<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="synchronized与锁"><a href="#synchronized与锁" class="header-anchor">#</a> synchronized与锁</h1> <p>这篇文章我们来聊一聊Java多线程里面的“锁”。</p> <p>首先需要明确的一点是：<strong>Java多线程的锁都是基于对象的</strong>，Java中的每一个对象都可以作为一个锁。</p> <p>还有一点需要注意的是，我们常听到的<strong>类锁</strong>其实也是对象锁。</p> <p>Java类只有一个Class对象（可以有多个实例对象，多个实例共享这个Class对象），而Class对象也是特殊的Java对象。所以我们常说的类锁，其实就是Class对象的锁。</p> <h2 id="synchronized关键字"><a href="#synchronized关键字" class="header-anchor">#</a> Synchronized关键字</h2> <p>说到锁，我们通常会谈到<code>synchronized</code>这个关键字。它翻译成中文就是“同步”的意思。</p> <p>我们通常使用<code>synchronized</code>关键字来给一段代码或一个方法上锁。它通常有以下三种形式：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 关键字在实例方法上，锁为当前实例</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">instanceLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// code</span>
<span class="token punctuation">}</span>

<span class="token comment">// 关键字在静态方法上，锁为当前Class对象</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">classLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// code</span>
<span class="token punctuation">}</span>

<span class="token comment">// 关键字在代码块上，锁为括号里面的对象</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">blockLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// code</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>我们这里介绍一下“临界区”的概念。所谓“临界区”，指的是某一块代码区域，它同一时刻只能由一个线程执行。在上面的例子中，如果<code>synchronized</code>关键字在方法上，那临界区就是整个方法内部。而如果是使用synchronized代码块，那临界区就指的是代码块内部的区域。</p> <p>通过上面的例子我们可以看到，下面这两个写法其实是等价的作用：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 关键字在实例方法上，锁为当前实例</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">instanceLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// code</span>
<span class="token punctuation">}</span>

<span class="token comment">// 关键字在代码块上，锁为括号里面的对象</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">blockLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// code</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>同理，下面这两个方法也应该是等价的：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 关键字在静态方法上，锁为当前Class对象</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">classLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// code</span>
<span class="token punctuation">}</span>

<span class="token comment">// 关键字在代码块上，锁为括号里面的对象</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">blockLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// code</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="几种锁"><a href="#几种锁" class="header-anchor">#</a> 几种锁</h2> <p>Java 6 为了减少获得锁和释放锁带来的性能消耗，引入了“偏向锁”和“轻量级锁“。在Java 6 以前，所有的锁都是”重量级“锁。所以在Java 6 及其以后，一个对象其实有四种锁状态，它们级别由低到高依次是：</p> <ol><li>无锁状态</li> <li>偏向锁状态</li> <li>轻量级锁状态</li> <li>重量级锁状态</li></ol> <p>无锁就是没有对资源进行锁定，任何线程都可以尝试去修改它，无锁在这里不再细讲。</p> <p>几种锁会随着竞争情况逐渐升级，锁的升级很容易发生，但是锁降级发生的条件会比较苛刻，锁降级发生在Stop The World期间，当JVM进入安全点的时候，会检查是否有闲置的锁，然后进行降级。</p> <blockquote><p>关于锁降级有两点说明：</p> <p>1.不同于大部分文章说锁不能降级，实际上HotSpot JVM 是支持锁降级的，文末有链接。</p> <p>2.上面提到的Stop The World期间，以及安全点，这些知识是属于JVM的知识范畴，本文不做细讲。</p></blockquote> <p>下面分别介绍这几种锁以及它们之间的升级。</p> <h3 id="java对象头"><a href="#java对象头" class="header-anchor">#</a> Java对象头</h3> <p>前面我们提到，Java的锁都是基于对象的。首先我们来看看一个对象的“锁”的信息是存放在什么地方的。</p> <p>每个Java对象都有对象头。如果是非数组类型，则用2个字宽来存储对象头，如果是数组，则会用3个字宽来存储对象头。在32位处理器中，一个字宽是32位；在64位虚拟机中，一个字宽是64位。对象头的内容如下表：</p> <table><thead><tr><th>长度</th> <th>内容</th> <th>说明</th></tr></thead> <tbody><tr><td>32/64bit</td> <td>Mark Word</td> <td>存储对象的hashCode或锁信息等</td></tr> <tr><td>32/64bit</td> <td>Class Metadata Address</td> <td>存储到对象类型数据的指针</td></tr> <tr><td>32/64bit</td> <td>Array length</td> <td>数组的长度（如果是数组）</td></tr></tbody></table> <p>我们主要来看看Mark Word的格式：</p> <table><thead><tr><th>锁状态</th> <th>29 bit 或 61 bit</th> <th>1 bit 是否是偏向锁？</th> <th>2 bit 锁标志位</th></tr></thead> <tbody><tr><td>无锁</td> <td></td> <td>0</td> <td>01</td></tr> <tr><td>偏向锁</td> <td>线程ID</td> <td>1</td> <td>01</td></tr> <tr><td>轻量级锁</td> <td>指向栈中锁记录的指针</td> <td>此时这一位不用于标识偏向锁</td> <td>00</td></tr> <tr><td>重量级锁</td> <td>指向互斥量（重量级锁）的指针</td> <td>此时这一位不用于标识偏向锁</td> <td>10</td></tr> <tr><td>GC标记</td> <td></td> <td>此时这一位不用于标识偏向锁</td> <td>11</td></tr></tbody></table> <p>可以看到，当对象状态为偏向锁时，<code>Mark Word</code>存储的是偏向的线程ID；当状态为轻量级锁时，<code>Mark Word</code>存储的是指向线程栈中<code>Lock Record</code>的指针；当状态为重量级锁时，<code>Mark Word</code>为指向堆中的monitor对象的指针。</p> <h3 id="偏向锁"><a href="#偏向锁" class="header-anchor">#</a> 偏向锁</h3> <p>Hotspot的作者经过以往的研究发现大多数情况下<strong>锁不仅不存在多线程竞争，而且总是由同一线程多次获得</strong>，于是引入了偏向锁。</p> <p>偏向锁会偏向于第一个访问锁的线程，如果在接下来的运行过程中，该锁没有被其他的线程访问，则持有偏向锁的线程将永远不需要触发同步。也就是说，<strong>偏向锁在资源无竞争情况下消除了同步语句，连CAS操作都不做了，提高了程序的运行性能。</strong></p> <blockquote><p>大白话就是对锁置个变量，如果发现为true，代表资源无竞争，则无需再走各种加锁/解锁流程。如果为false，代表存在其他线程竞争资源，那么就会走后面的流程。</p></blockquote> <h4 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> <strong>实现原理</strong></h4> <p>一个线程在第一次进入同步块时，会在对象头和栈帧中的锁记录里存储锁的偏向的线程ID。当下次该线程进入这个同步块时，会去检查锁的Mark Word里面是不是放的自己的线程ID。</p> <p>如果是，表明该线程已经获得了锁，以后该线程在进入和退出同步块时不需要花费CAS操作来加锁和解锁 ；如果不是，就代表有另一个线程来竞争这个偏向锁。这个时候会尝试使用CAS来替换Mark Word里面的线程ID为新线程的ID，这个时候要分两种情况：</p> <ul><li>成功，表示之前的线程不存在了， Mark Word里面的线程ID为新线程的ID，锁不会升级，仍然为偏向锁；</li> <li>失败，表示之前的线程仍然存在，那么暂停之前的线程，设置偏向锁标识为0，并设置锁标志位为00，升级为轻量级锁，会按照轻量级锁的方式进行竞争锁。</li></ul> <blockquote><p>CAS: Compare and Swap</p> <p>比较并设置。用于在硬件层面上提供原子性操作。在 Intel 处理器中，比较并交换通过指令cmpxchg实现。 比较是否和给定的数值一致，如果一致则修改，不一致则不修改。</p></blockquote> <p>线程竞争偏向锁的过程如下：</p> <p><img src="https://fitminfpicgo.oss-cn-guangzhou.aliyuncs.com/picgo/202209291420741.jpg" alt="img"></p> <p>图中涉及到了lock record指针指向当前堆栈中的最近一个lock record，是轻量级锁按照先来先服务的模式进行了轻量级锁的加锁。</p> <h4 id="撤销偏向锁"><a href="#撤销偏向锁" class="header-anchor">#</a> 撤销偏向锁</h4> <p>偏向锁使用了一种<strong>等到竞争出现才释放锁的机制</strong>，所以当其他线程尝试竞争偏向锁时， 持有偏向锁的线程才会释放锁。</p> <p>偏向锁升级成轻量级锁时，会暂停拥有偏向锁的线程，重置偏向锁标识，这个过程看起来容易，实则开销还是很大的，大概的过程如下：</p> <ol><li>在一个安全点（在这个时间点上没有字节码正在执行）停止拥有锁的线程。</li> <li>遍历线程栈，如果存在锁记录的话，需要修复锁记录和Mark Word，使其变成无锁状态。</li> <li>唤醒被停止的线程，将当前锁升级成轻量级锁。</li></ol> <p>所以，如果应用程序里所有的锁通常处于竞争状态，那么偏向锁就会是一种累赘，对于这种情况，我们可以一开始就把偏向锁这个默认功能给关闭：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">UseBiasedLocking</span><span class="token operator">=</span><span class="token boolean">false</span>。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面这个经典的图总结了偏向锁的获得和撤销：</p> <p><img src="https://fitminfpicgo.oss-cn-guangzhou.aliyuncs.com/picgo/202209291417033.png" alt="img"></p> <h3 id="轻量级锁"><a href="#轻量级锁" class="header-anchor">#</a> 轻量级锁</h3> <p>多个线程在不同时段获取同一把锁，即不存在锁竞争的情况，也就没有线程阻塞。针对这种情况，JVM采用轻量级锁来避免线程的阻塞与唤醒。</p> <h4 id="轻量级锁的加锁"><a href="#轻量级锁的加锁" class="header-anchor">#</a> 轻量级锁的加锁</h4> <p>JVM会为每个线程在当前线程的栈帧中创建用于存储锁记录的空间，我们称为Displaced Mark Word。如果一个线程获得锁的时候发现是轻量级锁，会把锁的Mark Word复制到自己的Displaced Mark Word里面。</p> <p>然后线程尝试用CAS将锁的Mark Word替换为指向锁记录的指针。如果成功，当前线程获得锁，如果失败，表示Mark Word已经被替换成了其他线程的锁记录，说明在与其它线程竞争锁，当前线程就尝试使用自旋来获取锁。</p> <blockquote><p>自旋：不断尝试去获取锁，一般用循环来实现。</p></blockquote> <p>自旋是需要消耗CPU的，如果一直获取不到锁的话，那该线程就一直处在自旋状态，白白浪费CPU资源。解决这个问题最简单的办法就是指定自旋的次数，例如让其循环10次，如果还没获取到锁就进入阻塞状态。</p> <p>但是JDK采用了更聪明的方式——适应性自旋，简单来说就是线程如果自旋成功了，则下次自旋的次数会更多，如果自旋失败了，则自旋的次数就会减少。</p> <p>自旋也不是一直进行下去的，如果自旋到一定程度（和JVM、操作系统相关），依然没有获取到锁，称为自旋失败，那么这个线程会阻塞。同时这个锁就会<strong>升级成重量级锁</strong>。</p> <p><strong>轻量级锁的释放：</strong></p> <p>在释放锁时，当前线程会使用CAS操作将Displaced Mark Word的内容复制回锁的Mark Word里面。如果没有发生竞争，那么这个复制的操作会成功。如果有其他线程因为自旋多次导致轻量级锁升级成了重量级锁，那么CAS操作会失败，此时会释放锁并唤醒被阻塞的线程。</p> <p>一张图说明加锁和释放锁的过程：</p> <p><img src="https://fitminfpicgo.oss-cn-guangzhou.aliyuncs.com/picgo/202209291417357.png" alt="img"></p> <h3 id="重量级锁"><a href="#重量级锁" class="header-anchor">#</a> 重量级锁</h3> <p>重量级锁依赖于操作系统的互斥量（mutex） 实现的，而操作系统中线程间状态的转换需要相对比较长的时间，所以重量级锁效率很低，但被阻塞的线程不会消耗CPU。</p> <p>前面说到，每一个对象都可以当做一个锁，当多个线程同时请求某个对象锁时，对象锁会设置几种状态用来区分请求的线程：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Contention List：所有请求锁的线程将被首先放置到该竞争队列
Entry List：Contention List中那些有资格成为候选人的线程被移到Entry List
Wait Set：那些调用wait方法被阻塞的线程被放置到Wait Set
OnDeck：任何时刻最多只能有一个线程正在竞争锁，该线程称为OnDeck
Owner：获得锁的线程称为Owner
!Owner：释放锁的线程
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>当一个线程尝试获得锁时，如果该锁已经被占用，则会将该线程封装成一个<code>ObjectWaiter</code>对象插入到Contention List的队列的队首，然后调用<code>park</code>函数挂起当前线程。</p> <p>当线程释放锁时，会从Contention List或EntryList中挑选一个线程唤醒，被选中的线程叫做<code>Heir presumptive</code>即假定继承人，假定继承人被唤醒后会尝试获得锁，但<code>synchronized</code>是非公平的，所以假定继承人不一定能获得锁。这是因为对于重量级锁，线程先自旋尝试获得锁，这样做的目的是为了减少执行操作系统同步操作带来的开销。如果自旋不成功再进入等待队列。这对那些已经在等待队列中的线程来说，稍微显得不公平，还有一个不公平的地方是自旋线程可能会抢占了Ready线程的锁。</p> <p>如果线程获得锁后调用<code>Object.wait</code>方法，则会将线程加入到WaitSet中，当被<code>Object.notify</code>唤醒后，会将线程从WaitSet移动到Contention List或EntryList中去。需要注意的是，当调用一个锁对象的<code>wait</code>或<code>notify</code>方法时，<strong>如当前锁的状态是偏向锁或轻量级锁则会先膨胀成重量级锁</strong>。</p> <h3 id="总结锁的升级流程"><a href="#总结锁的升级流程" class="header-anchor">#</a> 总结锁的升级流程</h3> <p>每一个线程在准备获取共享资源时： 第一步，检查MarkWord里面是不是放的自己的ThreadId ,如果是，表示当前线程是处于 “偏向锁” 。</p> <p>第二步，如果MarkWord不是自己的ThreadId，锁升级，这时候，用CAS来执行切换，新的线程根据MarkWord里面现有的ThreadId，通知之前线程暂停，之前线程将Markword的内容置为空。</p> <p>第三步，两个线程都把锁对象的HashCode复制到自己新建的用于存储锁的记录空间，接着开始通过CAS操作， 把锁对象的MarKword的内容修改为自己新建的记录空间的地址的方式竞争MarkWord。</p> <p>第四步，第三步中成功执行CAS的获得资源，失败的则进入自旋 。</p> <p>第五步，自旋的线程在自旋过程中，成功获得资源(即之前获的资源的线程执行完成并释放了共享资源)，则整个状态依然处于 轻量级锁的状态，如果自旋失败 。</p> <p>第六步，进入重量级锁的状态，这个时候，自旋的线程进行阻塞，等待之前线程执行完成并唤醒自己。</p> <h3 id="各种锁的优缺点对比"><a href="#各种锁的优缺点对比" class="header-anchor">#</a> 各种锁的优缺点对比</h3> <p>下表来自《Java并发编程的艺术》：</p> <table><thead><tr><th>锁</th> <th>优点</th> <th>缺点</th> <th>适用场景</th></tr></thead> <tbody><tr><td>偏向锁</td> <td>加锁和解锁不需要额外的消耗，和执行非同步方法比仅存在纳秒级的差距。</td> <td>如果线程间存在锁竞争，会带来额外的锁撤销的消耗。</td> <td>适用于只有一个线程访问同步块场景。</td></tr> <tr><td>轻量级锁</td> <td>竞争的线程不会阻塞，提高了程序的响应速度。</td> <td>如果始终得不到锁竞争的线程使用自旋会消耗CPU。</td> <td>追求响应时间。同步块执行速度非常快。</td></tr> <tr><td>重量级锁</td> <td>线程竞争不使用自旋，不会消耗CPU。</td> <td>线程阻塞，响应时间缓慢。</td> <td>追求吞吐量。同步块执行时间较长。</td></tr></tbody></table></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/blog/tags/?tag=%E5%B9%B6%E5%8F%91" title="标签">#并发</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/06/18, 18:02:03</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/blog/pages/9117624F898B90EBCA2D62EB460494B3/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">volatile</div></a> <a href="/blog/pages/2DF17B63FC62C4F8A42E7571CC8950E3/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">CAS 与原子操作</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/pages/9117624F898B90EBCA2D62EB460494B3/" class="prev">volatile</a></span> <span class="next"><a href="/blog/pages/2DF17B63FC62C4F8A42E7571CC8950E3/">CAS 与原子操作</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:fitminf@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/Fitminf" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2024
    <span>Fitminf | <a href="https://gitee.com/fitminf" target="_blank">Fitminf License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.c0e2c8ea.js" defer></script><script src="/blog/assets/js/2.5f0b0e2a.js" defer></script><script src="/blog/assets/js/25.57d86784.js" defer></script>
  </body>
</html>
